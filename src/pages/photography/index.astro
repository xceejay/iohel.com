---
import type { ImageMetadata } from "astro";
import { Image } from "astro:assets";
import { getEntry } from "astro:content";
import Container from "@/components/Container.astro";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { DEFAULT_CONFIGURATION } from "@/lib/constants";
import "@fancyapps/ui/dist/fancybox/fancybox.css";

const entry = await getEntry("pages", "photography");

// images are in src/content/photos
const photos = import.meta.glob<{ default: ImageMetadata }>(
  "../../content/photos/*.{jpg,jpeg,png,webp,avif}"
);
---

<BaseLayout seo={entry.data.seo}>
  <Container as="section" class="py-6">
    <div class="flex flex-col gap-6">
      <span class="text-headings text-4xl">Photos I made</span>
    </div>
  </Container>

  {/* Full width gallery. Do not wrap this in Container */}
  <section class="justified-gallery" id="photoswipe">
    {
      Object.entries(photos).map(async ([_path, mod], index) => {
        const { default: imageData } = await mod();
        return (
          <a
            style={`--width: ${imageData.width}; --height: ${imageData.height};`}
            href={imageData.src}
            target="_blank"
            data-fancybox="gallery"
          >
            <Image
              format="webp"
              src={imageData}
              alt=""
              height={400}
              loading={index < 20 ? "eager" : "lazy"}
            />
          </a>
        );
      })
    }
  </section>
</BaseLayout>

<script>
  import { Fancybox } from "@fancyapps/ui/dist/fancybox/";
  import { Compactmode } from "@fancyapps/ui/dist/fancybox/fancybox.compactmode.js";
  import "@fancyapps/ui/dist/fancybox/fancybox.compactmode.css";

  Fancybox.bind("[data-fancybox='gallery']", {
    plugins: {
      Compactmode,
    },
    Thumbs: {
      type: "classic",
      showOnStart: false,
    },
    Carousel: {
      Arrows: true,
    },
    Toolbar: {
      display: {
        left: [],
        middle: [],
        right: ["close"],
      },
    },
  });
</script>

<style>
  .justified-gallery {
    position: relative;
    z-index: 0;
    width: 100%;

    --padding: max(2.5vw, 12px);
    --space: max(2.5vw, 12px);
    --min-height: clamp(200px, 20vw, 400px);

    padding: var(--padding);
    display: flex;
    flex-wrap: wrap;
    gap: var(--space);
    align-items: stretch;
  }

  .justified-gallery a {
    flex-grow: calc(var(--width) * (100000 / var(--height)));
    flex-basis: calc(var(--min-height) * (var(--width) / var(--height)));
    aspect-ratio: var(--width) / var(--height);
    overflow: hidden;
    transition: transform 0.05s ease-in-out;
    border-radius: 6px;
  }

  .justified-gallery a img {
    display: block;
    object-fit: cover;
    height: 100%;
    width: 100%;
  }

  .justified-gallery a:focus-visible {
    outline: 3px solid var(--outline);
    outline-offset: 2px;
    transform: scale(1.03);
    z-index: 1;
  }

  .justified-gallery::after {
    content: " ";
    flex-grow: 1000000000;
  }
</style>
